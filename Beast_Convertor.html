<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MP3 Converter</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- LAME MP3 -->
<script src="lucide.min.js"></script>
<script src="lame.min.js"></script>
<!-- Lucide Icons -->
<script src="browser-id3-writer.min.js"></script>

<style>
*{
transition:all ease 0.3s
}
:root{
  --primary:#0091ea;
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#111;
  --shadow:0 10px 30px rgba(0,0,0,.15);
  
}
[data-theme="dark"]{
  --bg:#0b1117;
  --card:#121a22;
  --text:#e6f1ff;
}

*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden; /* ðŸ”’ no page scroll */
}

.card{
  width:95%;
  max-width:420px;
  background:var(--card);
  border-radius:20px;
  padding:20px;
  box-shadow:var(--shadow);
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
}

h1{
  font-size:18px;
  margin:0;
}

.icon-btn{
  background:none;
  border:none;
  color:var(--primary);
}

.glow{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(0,145,234,.4);
  background:transparent;
  color:var(--text);
  outline:none;
  box-shadow:0 0 10px rgba(0,145,234,.3);
  margin-top:6px;
}

label{
  font-size:13px;
  opacity:.8;
  display:block;
  margin-top:12px;
}

button.main{
  position:relative;
  overflow:hidden;
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  background:var(--primary);
  color:white;
  font-size:15px;
  margin-top:18px;
  box-shadow:0 0 25px rgba(0,145,234,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

button.main::after{
  content:"";
  position:absolute;
  inset:0;
  background:radial-gradient(circle,rgba(255,255,255,.4),transparent 60%);
  opacity:0;
}
button.main:active::after{opacity:1}

.art{
  width:120px;
  height:120px;
  margin:14px auto;
  border-radius:16px;

  background-color:var(--card);

  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;

  box-shadow:0 0 20px rgba(0,145,234,.6);
  overflow:hidden;
  position:relative;
}

/* Only show gradient when no image */
.art::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(
    135deg,
    rgba(0,145,234,.15),
    rgba(0,0,0,.05)
  );
  pointer-events:none;
}
*{
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
}
input, textarea{
  -webkit-user-select: text;
  user-select: text;
}
.file-box{
  display:flex;
  align-items:center;
  gap:10px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(0,145,234,.5);
  color:var(--text);
  box-shadow:0 0 15px rgba(0,145,234,.35);
  cursor:pointer;
  transition:.2s;
}

.file-box:active{
  transform:scale(.98);
  box-shadow:0 0 25px rgba(0,145,234,.7);
}
.audio-box{
  margin-top:14px;
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(0,145,234,.4);
  box-shadow:0 0 15px rgba(0,145,234,.35);
}

audio{
  width:100%;
  outline:none;
  filter: drop-shadow(0 0 8px rgba(0,145,234,.6));
}
body{
transition:all ease 0.3s
}
.app-content{
  flex:1;
  overflow-y:auto;
  padding:16px;

  display:flex;
  justify-content:center;   /* center horizontally */
  align-items:flex-start;   /* keep card at top */
}
.app-header{
  height:56px;
  
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  z-index:10;
}

.app-title{
  font-size:18px;
  font-weight:600;
  color:var(--text);
}
.app{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  background:var(--bg);
}

.icon-btn{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:none;
  border:none;
  color:var(--primary);
}

#h{
border-left:5px solid var(--primary);
padding-left:10px;
font-weight:700
}
/* Disable selection everywhere */
*{
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

/* Slider container */
.control{
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* Range base */
input[type=range]{
  -webkit-appearance:none;
  appearance:none;
  height:6px;
  border-radius:6px;
  background:linear-gradient(90deg,#0091ea,#00c6ff);
  outline:none;
  box-shadow:0 0 10px #0091ea88;
}

/* Thumb */
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:20px;
  height:20px;
  border-radius:50%;
  background:#fff;
  box-shadow:
    0 0 8px #0091ea,
    0 0 20px #0091ea;
  cursor:pointer;
  transition:transform .15s;
}

input[type=range]:active::-webkit-slider-thumb{
  transform:scale(1.2);
}

/* Firefox */
input[type=range]::-moz-range-thumb{
  width:20px;
  height:20px;
  border-radius:50%;
  background:#fff;
  box-shadow:0 0 15px #0091ea;
}
.control-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  opacity:.9;
}

.control-head span{
  font-weight:600;
  color:var(--primary);
  text-shadow:0 0 8px rgba(0,145,234,.6);
}
button.main.loading{
  opacity:.8;
  pointer-events:none;
}

.loader{
  width:18px;
  height:18px;
  border:3px solid rgba(255,255,255,.4);
  border-top:3px solid white;
  border-radius:50%;
  animation:spin .8s linear infinite;
}

@keyframes spin{
  to{ transform:rotate(360deg); }
}
.overlay{
  position:fixed;
  inset:0;
  backdrop-filter:blur(8px);
  background:rgba(0,0,0,.4);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
  transition:.3s;
}

.overlay.hidden{
  opacity:0;
  pointer-events:none;
}

.overlay-box{
  background:var(--card);
  padding:30px;
  border-radius:20px;
  box-shadow:0 0 40px rgba(0,145,234,.6);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:16px;
}

.big-loader{
  width:50px;
  height:50px;
  border:5px solid rgba(0,145,234,.3);
  border-top:5px solid var(--primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
}

.overlay-box p{
  margin:0;
  font-weight:600;
  color:var(--primary);
  text-shadow:0 0 10px rgba(0,145,234,.6);
}
.close-btn{
  position:absolute;
  top:12px;
  right:12px;
  background:none;
  border:none;
  font-size:18px;
  color:var(--primary);
  cursor:pointer;
}

.overlay-box{
  position:relative;
}
</style>
</head>

<body>
<div id="overlay" class="overlay hidden">
  <div class="overlay-box">
    <button class="close-btn" onclick="hideOverlay()"></button>
    <div class="big-loader" id="overlayLoader"></div>
    <p id="overlayText">Processing Audio...</p>
  </div>
</div>

<div class="app", alig="center">

  <div class="app-header">
  <button class="icon-btn" onclick="goBack()">
    <i data-lucide="arrow-left"></i>
  </button>

  <div class="app-title"><h3 id="h">Beast Converter</h3></div>

  <button class="icon-btn" onclick="toggleTheme()">
    <i data-lucide="sun-moon"></i>
  </button>
</div>

  <div class="app-content">
    <div class="card">

      <label class="file-box" onclick="audio.click()">
        <i data-lucide="music"></i>
        <span id="audioName">Select audio file</span>
      </label>
      <input type="file" id="audio" accept="audio/*" hidden>

      <label class="file-box" onclick="artwork.click()">
        <i data-lucide="image"></i>
        <span id="artName">Select artwork</span>
      </label>
      <input type="file" id="artwork" accept="image/*" hidden>

      <label><i data-lucide="edit-3"></i> Output file name</label>
      <input id="outputName" class="glow" placeholder="song_name">
<div class="control">
  <div class="control-head">
    <label>Bass</label>
    
  </div>
  <input type="range" id="bass" min="-10" max="20" value="0">
  <div class="control-head">
  <span id="bassVal">0 x</span>
  </div>
</div>

<div class="control">
  <div class="control-head">
    <label>Reverb</label>
    
  </div>
  <input type="range" id="reverb" min="0" max="1" step="0.01" value="0">
  <div class="control-head">
  <span id="reverbVal">0%</span>
  </div>
</div>

<div class="control">
  <div class="control-head">
    <label>Loudness</label>
    
  </div>
  <input type="range" id="loudness" min="0.5" max="2" step="0.1" value="1">
  <div class="control-head">
  <span id="loudnessVal">1.0dB</span>
  </div>
</div>
<div class="audio-box">
        <audio id="preview" controls></audio>
      </div>

      <div class="art" id="art"></div>

   

      <button class="main" onclick="convert()">
        <i data-lucide="zap"></i>
        Convert to MP3
      </button>

    </div>
  </div>

</div>

<script>
lucide.createIcons();
document.addEventListener("click", () => {
  if(!window.audioCtx){
    window.audioCtx = new AudioContext();
  }
}, { once: true });

const root=document.documentElement;
root.dataset.theme=localStorage.theme||"dark";
let audioCtx, sourceNode;
let bassFilter;
let convolver;
let dryGain, wetGain;
let artworkFile = null;

function createReverbImpulse(ctx, duration, decay){
  const rate = ctx.sampleRate;
  const length = rate * duration;
  const impulse = ctx.createBuffer(2, length, rate);

  for(let i=0;i<2;i++){
    const channel = impulse.getChannelData(i);
    for(let j=0;j<length;j++){
      channel[j] = (Math.random()*2-1) * Math.pow(1 - j/length, decay);
    }
  }
  return impulse;
}bass.oninput = () => {
  if(bassFilter){
    bassFilter.gain.value = bass.value;
  }
};

reverb.oninput = () => {
  if(wetGain){
    wetGain.gain.value = reverb.value;
  }
};
let compressor;
let loudnessGain;
function setupAudioFX(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  sourceNode = audioCtx.createMediaElementSource(preview);

  // Bass
  bassFilter = audioCtx.createBiquadFilter();
  bassFilter.type="lowshelf";
  bassFilter.frequency.value=100;
  bassFilter.gain.value=0;

  // Loudness normalizer
  compressor = audioCtx.createDynamicsCompressor();
  compressor.threshold.value = -18;
  compressor.knee.value = 30;
  compressor.ratio.value = 4;
  compressor.attack.value = 0.003;
  compressor.release.value = 0.25;

  loudnessGain = audioCtx.createGain();
  loudnessGain.gain.value = 1;

  // Reverb
  convolver = audioCtx.createConvolver();
  convolver.buffer = createReverbImpulse(audioCtx,2,2);

  dryGain = audioCtx.createGain();
  wetGain = audioCtx.createGain();
  dryGain.gain.value = 1;
  wetGain.gain.value = 0;

  // ROUTING (clean & pro)
  sourceNode
    .connect(bassFilter)
    .connect(compressor)
    .connect(loudnessGain);

  loudnessGain.connect(dryGain).connect(audioCtx.destination);
  loudnessGain.connect(convolver).connect(wetGain).connect(audioCtx.destination);
}
loudness.oninput = ()=>{
  if(loudnessGain){
    loudnessGain.gain.value = loudness.value;
  }
};


function toggleTheme(){
  root.dataset.theme=root.dataset.theme==="dark"?"light":"dark";
  localStorage.theme=root.dataset.theme;
}

function readFileAsArrayBuffer(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = e => resolve(e.target.result);
    reader.onerror = () => reject(new Error("File read failed"));

    reader.readAsArrayBuffer(file);
  });
}
async function convert(){

const btn = document.querySelector("button.main");

try{

btn.classList.add("loading");
btn.innerHTML = `<div class="loader"></div> Processing...`;

showOverlay("Decoding Audio...", true);

const file = audio.files[0];
if(!file){
  throw new Error("No audio file selected.");
}

const arrayBuffer = await file.arrayBuffer();

const tempCtx = new AudioContext();
const decoded = await tempCtx.decodeAudioData(arrayBuffer);

showOverlay("Processing...", true);

const offlineCtx = new OfflineAudioContext(
  decoded.numberOfChannels,
  decoded.length,
  44100
);

const source = offlineCtx.createBufferSource();
source.buffer = decoded;

const bassFilter = offlineCtx.createBiquadFilter();
bassFilter.type = "lowshelf";
bassFilter.frequency.value = 100;
bassFilter.gain.value = Number(bass.value);

const compressor = offlineCtx.createDynamicsCompressor();
compressor.threshold.value = -18;
compressor.ratio.value = 4;

const gainNode = offlineCtx.createGain();
gainNode.gain.value = Number(loudness.value);

const convolver = offlineCtx.createConvolver();
convolver.buffer = createReverbImpulse(offlineCtx,2,2);

const wetGain = offlineCtx.createGain();
wetGain.gain.value = Number(reverb.value);

const dryGain = offlineCtx.createGain();
dryGain.gain.value = 1 - Number(reverb.value);

source.connect(bassFilter)
      .connect(compressor)
      .connect(gainNode);

gainNode.connect(dryGain).connect(offlineCtx.destination);
gainNode.connect(convolver).connect(wetGain).connect(offlineCtx.destination);

source.start(0);

const renderedBuffer = await offlineCtx.startRendering();

showOverlay("Encoding MP3 320kbps...", true);

const mp3encoder = new lamejs.Mp3Encoder(
  renderedBuffer.numberOfChannels,
  44100,
  320
);

const left = renderedBuffer.getChannelData(0);
const right = renderedBuffer.numberOfChannels > 1
  ? renderedBuffer.getChannelData(1)
  : left;

const blockSize = 1152;
let mp3Data = [];

for(let i=0;i<left.length;i+=blockSize){

  const leftChunk = left.subarray(i,i+blockSize);
  const rightChunk = right.subarray(i,i+blockSize);

  const left16 = new Int16Array(leftChunk.length);
  const right16 = new Int16Array(rightChunk.length);

  for(let j=0;j<leftChunk.length;j++){
    left16[j] = leftChunk[j]*32767;
    right16[j] = rightChunk[j]*32767;
  }

  const mp3buf = mp3encoder.encodeBuffer(left16,right16);
  if(mp3buf.length>0) mp3Data.push(mp3buf);
}

const endBuf = mp3encoder.flush();
if(endBuf.length>0) mp3Data.push(endBuf);

let blob = new Blob(mp3Data,{type:"audio/mp3"});

if(artworkFile){
  showOverlay("Writing Artwork...", true);

  const writer = new ID3Writer(await blob.arrayBuffer());
  const imgBuf = await artworkFile.arrayBuffer();

  writer.setFrame("APIC",{
    type:3,
    data:imgBuf,
    description:"Cover",
    mimeType:artworkFile.type
  });

  writer.addTag();
  blob = new Blob([writer.arrayBuffer],{type:"audio/mp3"});
}

const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=(outputName.value||"output")+".mp3";
a.click();

showOverlay("Conversion Successful ", false);

setTimeout(hideOverlay,1500);

}catch(error){

showOverlay("Conversion Failed!\nTry smaller file or reload app.", false);

console.error(error);

}finally{

btn.classList.remove("loading");
btn.innerHTML = `
  <i data-lucide="zap"></i>
  Convert to MP3
`;
lucide.createIcons();

}
}
audio.onchange = () => {
  if (!audio.files.length) return;

  const file = audio.files[0];
  audioName.textContent = file.name;

  const cleanName = file.name.replace(/\.[^/.]+$/, "");
  outputName.value = cleanName;

  preview.src = URL.createObjectURL(file);
  preview.load();

  preview.onplay = () => {
    if(!audioCtx) setupAudioFX();
    audioCtx.resume();
  };
};

artwork.onchange = () => {
  if(!artwork.files.length) return;

  artworkFile = artwork.files[0];
  artName.textContent = artworkFile.name;

  const reader = new FileReader();
  reader.onload = e => {
    art.style.backgroundImage = `url(${e.target.result})`;
  };
  reader.readAsDataURL(artworkFile);
};
function goBack(){
  window.location.href = "index.html";
}
// Bass
bass.oninput = ()=>{
  bassVal.textContent = bass.value + " x";
  if(bassFilter){
    bassFilter.gain.value = bass.value;
  }
};

// Reverb
reverb.oninput = ()=>{
  const v = Math.round(reverb.value * 100);
  reverbVal.textContent = v + "%";
  if(wetGain && dryGain){
    wetGain.gain.value = reverb.value;
    dryGain.gain.value = 1 - reverb.value;
  }
};

// Loudness
loudness.oninput = ()=>{
  loudnessVal.textContent = Number(loudness.value).toFixed(2) + "dB";
  if(loudnessGain){
    loudnessGain.gain.value = loudness.value;
  }
};
function showOverlay(text, loading=true){
  overlay.classList.remove("hidden");
  overlayText.textContent = text;

  if(loading){
    overlayLoader.style.display = "block";
  }else{
    overlayLoader.style.display = "none";
  }
}

function hideOverlay(){
  overlay.classList.add("hidden");
}
</script>
</body>
</html>