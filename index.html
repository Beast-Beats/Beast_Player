<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffb300">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Beast Player</title>

<style>
:root{
    --bg:#0f0f0f;
    --card:#1b1b1b;
    --box:#111;
    --item:#222;
    --text:white;
    --accent:#FFC107;
}

body.light{
    --bg:#f3f3f3;
    --card:#ffffff;
    --box:#eaeaea;
    --item:#dedede;
    --text:#111;
}

body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui, Arial;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    transition:background .8s,color .8s;
}

.player{
    width:94%;
    max-width:420px;
    background:var(--card);
    padding:22px;
    border-radius:26px;
    box-shadow:0 25px 60px rgba(0,0,0,.6);
}

.top{
    display:flex;
    justify-content:space-between;
    align-items:center;
}

h1{margin:0;color:var(--accent);}

/* ---------- Buttons ---------- */
.btn,.ctrl,.toggle{
    border-radius:30px;
    padding:14px;
    cursor:pointer;
    user-select:none;
    transition:all .35s ease;
}

.btn{
    background:var(--accent);
    color:#000;
    font-weight:700;
    margin:18px 0;
    box-shadow:0 0 25px rgba(255,193,7,.6);
}

.btn:hover{box-shadow:0 0 35px rgba(255,193,7,.9);}
.btn:active{transform:translateY(4px) scale(.95);}

.ctrl{
    flex:1;
    background:var(--item);
    text-align:center;
    box-shadow:0 8px 20px rgba(0,0,0,.5);
}
.ctrl:active{transform:translateY(3px) scale(.96);}

.ctrl.active{
    background:var(--accent);
    color:#000;
    box-shadow:0 0 35px rgba(255,193,7,.9);
}

.toggle{
    background:var(--item);
    padding:10px 18px;
}
.toggle:active{transform:scale(.95);}

input{display:none}

/* ---------- Audio ---------- */
.audio-box{
    background:var(--box);
    padding:14px;
    border-radius:18px;
    transition:box-shadow .6s ease;
}
.audio-box.playing{
    box-shadow:0 0 40px var(--accent);
}
audio{width:100%}

/* ---------- Controls ---------- */
.controls{
    display:flex;
    gap:14px;
    margin:18px 0;
}

/* ---------- Playlist ---------- */
.playlist{
    max-height:240px;
    overflow-y:auto;
}

.song{
    background:var(--item);
    padding:16px;
    border-radius:18px;
    margin-bottom:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    transition:all .45s ease;
}

.song.active{
    background:var(--accent);
    color:#000;
    box-shadow:0 0 30px rgba(255,193,7,.9);
}

.song span{
    flex:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

/* ---------- Delete ---------- */
.del{
    width:28px;
    height:28px;
    background:#ff5252;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:900;
}

.song.removing{
    opacity:0;
    transform:translateX(120px);
}
</style>
</head>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/Beast_Player/sw.js");
}
</script>
<body>

<div class="player">
    <div class="top">
        <h1>Beast Player</h1>
        <div class="toggle" id="modeBtn">Mode</div>
    </div>
<br>
    <label class="btn">
        Add Songs
        <input type="file" id="fileInput" accept="audio/*" multiple>
    </label>
<br><br>
    <div class="audio-box" id="audioBox">
        <audio id="audio" controls></audio>
    </div>

    <div class="controls">
        <div class="ctrl" id="shuffleBtn">Shuffle</div>
        <div class="ctrl" id="repeatBtn">Repeat: OFF</div>
    </div>

    <div class="playlist" id="playlist"></div>
</div>

<script>
let db,songs=[],currentIndex=-1;
let shuffle=false,repeat=0;

const audio=document.getElementById("audio");
const playlist=document.getElementById("playlist");
const shuffleBtn=document.getElementById("shuffleBtn");
const repeatBtn=document.getElementById("repeatBtn");
const fileInput=document.getElementById("fileInput");
const audioBox=document.getElementById("audioBox");
const modeBtn=document.getElementById("modeBtn");

/* ---------- HAPTIC ---------- */
const vibrate=(ms=20)=>navigator.vibrate&&navigator.vibrate(ms);

/* ---------- MODE ---------- */
if(localStorage.getItem("mode")==="light")
    document.body.classList.add("light");

modeBtn.onclick=()=>{
    vibrate();
    document.body.classList.toggle("light");
    localStorage.setItem("mode",
        document.body.classList.contains("light")?"light":"dark");
};

/* ---------- DB ---------- */
const req=indexedDB.open("MusicDB",1);
req.onupgradeneeded=e=>{
    e.target.result.createObjectStore("songs",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
    db=e.target.result;
    loadSongs();
};

/* ---------- ADD ---------- */
fileInput.onchange=e=>{
    vibrate(30);
    const tx=db.transaction("songs","readwrite");
    const store=tx.objectStore("songs");
    [...e.target.files].forEach(f=>store.add({name:f.name,blob:f}));
    tx.oncomplete=loadSongs;
};

/* ---------- LOAD ---------- */
function loadSongs(){
    songs=[];
    playlist.innerHTML="";
    const tx=db.transaction("songs","readonly");
    const store=tx.objectStore("songs");

    store.openCursor().onsuccess=e=>{
        const cur=e.target.result;
        if(!cur) return;

        const index=songs.length;
        songs.push(cur.value);

        const div=document.createElement("div");
        div.className="song";
        div.innerHTML=`<span>${cur.value.name}</span>`;
        div.onclick=()=>play(index);

        const del=document.createElement("div");
        del.className="del";
        del.textContent="Ã—";
        del.onclick=ev=>{
            ev.stopPropagation();
            vibrate(25);
            div.classList.add("removing");
            deleteSong(cur.key,div);
        };

        div.appendChild(del);
        playlist.appendChild(div);
        cur.continue();
    };
}

/* ---------- DELETE ---------- */
function deleteSong(id,el){
    const tx=db.transaction("songs","readwrite");
    tx.objectStore("songs").delete(id);
    tx.oncomplete=()=>setTimeout(loadSongs,400);
}

/* ---------- PLAY ---------- */
function play(i){
    if(!songs[i]) return;
    currentIndex=i;
    audio.src=URL.createObjectURL(songs[i].blob);
    audio.play();
    highlight();
    updateMedia();
}

audio.onplay=()=>audioBox.classList.add("playing");
audio.onpause=()=>audioBox.classList.remove("playing");

audio.onended=()=>{
    if(repeat===1) return audio.play();
    if(shuffle) return play(Math.floor(Math.random()*songs.length));
    if(currentIndex<songs.length-1) play(currentIndex+1);
    else if(repeat===2) play(0);
};

/* ---------- BUTTONS ---------- */
shuffleBtn.onclick=()=>{
    vibrate();
    shuffle=!shuffle;
    shuffleBtn.classList.toggle("active",shuffle);
};

repeatBtn.onclick=()=>{
    vibrate();
    repeat=(repeat+1)%3;
    repeatBtn.textContent=["Repeat: OFF","Repeat: ONE","Repeat: ALL"][repeat];
    repeatBtn.classList.toggle("active",repeat!==0);
};

/* ---------- UI ---------- */
function highlight(){
    document.querySelectorAll(".song").forEach((s,i)=>{
        s.classList.toggle("active",i===currentIndex);
    });
}

/* ---------- MEDIA SESSION ---------- */
function updateMedia(){
    if(!navigator.mediaSession) return;

    const colors=["#ff5252","#4caf50","#2196f3","#ff9800","#9c27b0"];
    const c=colors[Math.floor(Math.random()*colors.length)];

    navigator.mediaSession.metadata=new MediaMetadata({
        title:songs[currentIndex].name,
        artist:"Beast Player",
        artwork:[{src:`data:image/svg+xml,
        <svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'>
        <rect width='300' height='300' fill='${c}'/></svg>`}]
    });

    navigator.mediaSession.setActionHandler("nexttrack",()=>{
        if(currentIndex<songs.length-1) play(currentIndex+1);
    });
    navigator.mediaSession.setActionHandler("previoustrack",()=>{
        if(currentIndex>0) play(currentIndex-1);
    });
}
</script>

</body>
</html>